'use strict';

process.env.NODE_ENV = 'test';

const request = require('supertest');
const app = require('../../src/app-test');

// Mock the analytics services to isolate the hanging issue
jest.mock('../../src/services/bubbleAnalyticsService', () => ({
  getBubbleAnalytics: jest.fn().mockResolvedValue({
    questionnaire_id: 1,
    categories: [],
    total_responses: 0,
    response_rate: 0,
    generated_at: new Date().toISOString()
  }),
  validateQuestionnaireForBubbleAnalytics: jest.fn().mockResolvedValue({
    isValid: false,
    error: 'ANALYTICS_ERROR_001'
  })
}));

jest.mock('../../src/services/timeComparisonService', () => ({
  getTimeComparison: jest.fn().mockResolvedValue({
    questionnaire_id: 1,
    comparison_type: 'week',
    current_period: {},
    previous_period: {},
    comparison_metrics: {}
  })
}));

jest.mock('../../src/services/reportService', () => ({
  generateReport: jest.fn().mockResolvedValue({
    data: 'mock report data',
    contentType: 'text/csv',
    filename: 'analytics-report.csv'
  })
}));

describe('Analytics Mocked Services Test', () => {
  it('should handle analytics endpoint with mocked services', async () => {
    const response = await request(app)
      .get('/api/v1/analytics/bubble/99999')
      .set('Authorization', 'Bearer test-access-token-analytics-business')
      .timeout(5000); // 5 second timeout
    
    expect(response.status).toBe(404); // Should still return 404 for non-existent questionnaire
  }, 10000); // Test timeout of 10 seconds

  it('should handle analytics summary endpoint with mocked services', async () => {
    const response = await request(app)
      .get('/api/v1/analytics/summary/99999')
      .set('Authorization', 'Bearer test-access-token-analytics-business')
      .timeout(5000); // 5 second timeout
    
    expect(response.status).toBe(404); // Should still return 404 for non-existent questionnaire
  }, 10000); // Test timeout of 10 seconds
});